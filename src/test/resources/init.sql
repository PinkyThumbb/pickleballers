DROP TABLE IF EXISTS match CASCADE;
DROP TABLE IF EXISTS player CASCADE;

CREATE TABLE IF NOT EXISTS player (
      id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
      name TEXT NOT NULL,
      email TEXT,
      created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS match (
     id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
     playera_id BIGINT NOT NULL REFERENCES player(id) ON DELETE CASCADE,
     playerb_id BIGINT NOT NULL REFERENCES player(id) ON DELETE CASCADE,
     score TEXT,
     status TEXT DEFAULT 'PENDING',
     idempotency_key TEXT,
     created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- unique index to enforce single processing by idempotency key
CREATE UNIQUE INDEX IF NOT EXISTS uq_match_idempotency_key ON match(idempotency_key);
